-- Triggerbot + Diamond Tag System (Persistent)
-- Anyone running this script will see "draconvm ðŸ’Ž"

local Players = game:GetService("Players")
local UserInputService = game:GetService("UserInputService")
local RunService = game:GetService("RunService")
local Camera = workspace.CurrentCamera

local LocalPlayer = Players.LocalPlayer
local Mouse = LocalPlayer:GetMouse()

local Settings = {
    Enabled = false,
    ToggleKey = Enum.KeyCode.Q,
    MaxDistance = 1000,
    BlacklistedTools = { "Knife" },
    SpamPerSecond = 600,
}

local DiamondUser = "draconvm" -- <- NAME TO TAG

-- Blacklist table
local BlacklistedTools = {}
for _, name in ipairs(Settings.BlacklistedTools) do
    BlacklistedTools[name] = true
end

-- Function: check alive
local function isAlive(character)
    local hum = character and character:FindFirstChildOfClass("Humanoid")
    return hum and hum.Health > 0
end

-- Function: get usable tool
local function getUsableTool(character)
    for _, tool in ipairs(character:GetChildren()) do
        if tool:IsA("Tool") and not BlacklistedTools[tool.Name] then
            return tool
        end
    end
end

-- Function: distance
local function getDistance(a, b)
    local rootA = a:FindFirstChild("HumanoidRootPart") or a:FindFirstChild("Head")
    local rootB = b:FindFirstChild("HumanoidRootPart") or b:FindFirstChild("Head")
    if not rootA or not rootB then return math.huge end
    return (rootA.Position - rootB.Position).Magnitude
end

-- Function: line of sight
local function hasLineOfSight(targetChar)
    local camPos = Camera.CFrame.Position
    local targetRoot = targetChar and (targetChar:FindFirstChild("Head") or targetChar:FindFirstChild("HumanoidRootPart"))
    if not targetRoot then return false end

    local params = RaycastParams.new()
    params.FilterType = Enum.RaycastFilterType.Blacklist
    params.FilterDescendantsInstances = { LocalPlayer.Character }

    local result = workspace:Raycast(camPos, (targetRoot.Position - camPos), params)
    return not (result and result.Instance and not result.Instance:IsDescendantOf(targetChar))
end

-- Function: target under crosshair
local function getCrosshairTarget()
    local targetPart = Mouse.Target
    if not targetPart then return end
    local char = targetPart:FindFirstAncestorOfClass("Model")
    if not char or not isAlive(char) then return end
    local player = Players:GetPlayerFromCharacter(char)
    if not player or player == LocalPlayer then return end
    if getDistance(LocalPlayer.Character, char) > Settings.MaxDistance then return end
    if not hasLineOfSight(char) then return end
    return char, player
end

-- Toggle on/off
UserInputService.InputBegan:Connect(function(input, gp)
    if not gp and input.KeyCode == Settings.ToggleKey then
        Settings.Enabled = not Settings.Enabled
        print("Triggerbot:", Settings.Enabled and "Enabled" or "Disabled")
    end
end)

-- Diamond Tag Hook (auto refresh across rejoins)
local function getTaggedName(player)
    if player and player.Name == DiamondUser then
        return player.DisplayName .. " ðŸ’Ž"
    elseif player then
        return player.DisplayName
    end
end

local mt = getrawmetatable(game)
setreadonly(mt, false)

local oldIndex = mt.__index
mt.__index = function(obj, key)
    if key == "DisplayName" and typeof(obj) == "Instance" and obj:IsA("Player") then
        return getTaggedName(obj)
    end
    return oldIndex(obj, key)
end

-- Main loop
RunService.RenderStepped:Connect(function(dt)
    if not Settings.Enabled then return end

    local myChar = LocalPlayer.Character
    if not myChar or not isAlive(myChar) then return end

    local tool = getUsableTool(myChar)
    if not tool then return end

    local target, targetPlayer = getCrosshairTarget()
    if target then
        if tool.Parent ~= myChar then
            myChar:FindFirstChildOfClass("Humanoid"):EquipTool(tool)
        end

        -- Print target name (auto-tag applied)
        if targetPlayer then
            print("Targeting: " .. targetPlayer.DisplayName)
        else
            print("Targeting: Unknown")
        end

        local spamRate = math.max(1, math.floor(Settings.SpamPerSecond * dt))
        for i = 1, spamRate do
            task.defer(function()
                tool:Activate()
            end)
        end
    end
end)
